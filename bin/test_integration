#!/usr/bin/env bash

source bin/util

no_regen_client=0
no_rebuild_conjur=0

if [ "$(tty)" == "not a tty" ]; then
  copy_prefix="sudo"
else
  copy_prefix=""
fi

cleanup() {
  echo "Cleaning up..."
  docker-compose rm --stop --force -v
}

setup_keycloak(){
  announce "Setting up Keycloak"

  docker-compose exec -T oidc-keycloak bash -c "/scripts/create_client"
  docker-compose exec -T oidc-keycloak bash -c "/scripts/create_user bob bob bob@conjur.net"
  docker-compose exec -T conjur bash -c "/policy/oidc/fetchCertificate"
}

conjur_container_alive(){
  if [ -z `docker-compose ps -q conjur` ]; then
    echo 1
  elif [ -z `docker ps -q --no-trunc | grep $(docker-compose ps -q conjur)` ]; then
    echo 1
  else
    echo 0
  fi
}

print_help(){
  echo -e "Usage: ./bin/test_integration [--no-rebuild-conjur] [--no-regen-client]"
  echo
  echo -e "\tRunning this script without parameters will run ALL integration tests"
  echo -e "\tIn order to specify a subset of tests you can use a client flag (e.g. --python)"
  echo -e "\tYou can also specify a subset of client tests by including a parameter after the client flag"
  echo
  echo -e "\tThe --no-rebuild-conjur flag will prevent the conjur image from rebuilding"
  echo -e "\t\tWarning: this may cause some tests to fail"
  echo
  echo -e "\tThe --no-regen-client flag will prevent the client from re-generating before tests run"
  echo
  echo -e "\tThe -d flag will turn on debug mode for the integration test runs"
}

run_java_tests(){
  if [ $no_regen_client -eq 0 ]; then
    announce "Generating Java Client"
    bin/refresh_client -l java
  fi

  # Overwrite the autogenerated tests with the manually written tests
  #$copy_prefix rm -rf ./client/src/test/java/org/conjur/sdk/**/*
  #$copy_prefix cp -r ./test/integration/* ./client/src/test/java/org/conjur/sdk/api

  docker run --rm --network conjur-sdk-java \
    -v ${PWD}/client:/client \
    -v ${PWD}/test/config:/config \
    -v ${PWD}/config/https:/https \
    -e CONJUR_HTTP_APPLIANCE_URL=http://conjur \
    -e CONJUR_APPLIANCE_URL=https://conjur-https \
    -e CONJUR_ACCOUNT=dev \
    -e CONJUR_AUTHN_LOGIN=admin \
    -e CONJUR_CERT_FILE=/https/ca.crt \
    --env-file .env \
    -w /client \
    maven:3-openjdk-15 bash -c "mvn test"
}

while test $# -gt 0
do
  param=$1
  shift
  case "$param" in
    -d)
      DEBUG="true"
      ;;
    -h|--help)
      print_help
      exit 0
      ;;
    --no-rebuild-conjur)
      no_rebuild_conjur=1
      ;;
    --no-regen-client)
      no_regen_client=1
      ;;
    *)
      break
      ;;
  esac
done

if [ $no_rebuild_conjur -eq 0 ] || [ "$(conjur_container_alive)" = "1" ]; then
  announce "Starting Conjur Container"
  bin/start_conjur
fi

announce "Configuring Test Environment"
bin/get_conjur_admin_key
setup_keycloak

run_java_tests
